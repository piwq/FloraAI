# Morpheus Project

–ò–ò-—Ç–æ–ª–∫–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤ –Ω–∞ –±–∞–∑–µ YandexGPT. –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ Telegram-–±–æ—Ç–æ–º.

---

## –û –ø—Ä–æ–µ–∫—Ç–µ

**Morpheus** ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π. –ü—Ä–æ–µ–∫—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö **–≤—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–æ–≥–æ —Ö–∞–∫–∞—Ç–æ–Ω–∞ ¬´–ö–∏–±–µ—Ä102¬ª**, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏–ª **—Å 14 –ø–æ 16 –Ω–æ—è–±—Ä—è 2025 –≥–æ–¥–∞**. –•–∞–∫–∞—Ç–æ–Ω –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è –Ω–∞ –±–∞–∑–µ –≤ –≥–æ—Ä–æ–¥–µ –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫ (–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω) —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥ —Å–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏. –ù–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞–¥–∞—á –¥–∞–≤–∞–ª–æ—Å—å **48 —á–∞—Å–æ–≤**.

### –ß—Ç–æ —É–º–µ–µ—Ç Morpheus?

Morpheus –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–Ω—è—Ç—å —Å–≤–æ–∏ —Å–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏. –°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏–º–≤–æ–ª–æ–≤, —ç–º–æ—Ü–∏–π –∏ —Å—é–∂–µ—Ç–æ–≤ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π, –ø—Ä–µ–¥–ª–∞–≥–∞—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º)

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç:

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç, —É–∫–∞–∑—ã–≤–∞—è email –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
2. **–û–ø–∏—Å–∞–Ω–∏–µ —Å–Ω–∞** ‚Äî –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–æ–π —Å–æ–Ω —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
3. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è** ‚Äî —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬´–ú–æ—Ä—Ñ–µ—É—Å¬ª –æ—Ç–≤–µ—á–∞–µ—Ç:
   - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã —Å–Ω–∞ (–≤–æ–¥–∞, –ø–æ–ª—ë—Ç, –¥–æ–º –∏ —Ç.–¥.)
   - –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
   - –°–≤—è–∑—ã–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ —Å–∏—Ç—É–∞—Ü–∏—è–º–∏
   - –ó–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞
4. **–î–∏–∞–ª–æ–≥** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Å–≤–æ–µ–º—É —Å–Ω—É
5. **–ò—Å—Ç–æ—Ä–∏—è** ‚Äî –≤—Å–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –∫ –Ω–∏–º –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞:

1. **–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç –±–æ—Ç–∞ –≤ Telegram –∏ –Ω–∞–∂–∏–º–∞–µ—Ç ¬´–°—Ç–∞—Ä—Ç¬ª
2. **–ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞** ‚Äî –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
3. **–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞** ‚Äî –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥¬ª –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–Ω–∞** ‚Äî –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ (–¥–ª—è Premium) –∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
5. **–û—Ç–≤–µ—Ç –ú–æ—Ä—Ñ–µ—É—Å–∞** ‚Äî –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å (Premium)
6. **–ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏** ‚Äî —á–µ—Ä–µ–∑ –º–µ–Ω—é ¬´–ü—Ä–æ—Ñ–∏–ª—å¬ª ‚Üí ¬´–ò—Å—Ç–æ—Ä–∏—è —Å–Ω–æ–≤¬ª

### –ß—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ:

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–æ–≤** ‚Äî –ò–ò –ø–æ–º–Ω–∏—Ç –≤–∞—à–∏ –ø—Ä–æ—à–ª—ã–µ —Å–Ω—ã –∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑–∏ –º–µ–∂–¥—É –Ω–∏–º–∏
- **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥** ‚Äî –Ω–∏–∫–∞–∫–æ–π –º–∏—Å—Ç–∏–∫–∏ –∏ –≥–∞–¥–∞–Ω–∏–π, —Ç–æ–ª—å–∫–æ –Ω–∞—É—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- **–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥** ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —Å–æ–Ω –≥–æ–ª–æ—Å–æ–º, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å
- **–û–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤** ‚Äî —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –≥–æ–ª–æ—Å–æ–º

### –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫:

| | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ | Premium |
|---|---|---|
| –°—Ç–∞—Ä—Ç–æ–≤—ã–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è | 3 | 20 –≤ –¥–µ–Ω—å |
| –ü–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è | 1 —Ä–∞–∑ –≤ 3 –¥–Ω—è | –°–±—Ä–æ—Å –∫–∞–∂–¥—É—é –Ω–æ—á—å |
| –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ | ‚Äî | –î–∞ |
| –û–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ | ‚Äî | –î–∞ |

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

1. [–°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π](#—Å—Ç–µ–∫-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö-prisma)
4. [–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤](#–¥–µ—Ç–∞–ª—å–Ω–æ–µ-–æ–ø–∏—Å–∞–Ω–∏–µ-—Å–µ—Ä–≤–∏—Å–æ–≤)
   - [API Gateway](#1-api-gateway)
   - [AI Service](#2-ai-service)
   - [TTS Service](#3-tts-service)
   - [ASR Service](#4-asr-service)
   - [Telegram Bot](#5-telegram-bot)
5. [–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã](#–∫–ª—é—á–µ–≤—ã–µ-–º–µ—Ö–∞–Ω–∏–∑–º—ã)
6. [API Endpoints](#api-endpoints)
7. [–ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞](#–∑–∞–ø—É—Å–∫-–ø—Ä–æ–µ–∫—Ç–∞)
8. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)

---

## –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ |
|-----------|------------|
| **API Gateway** | Express.js 5, Socket.IO 4, Prisma ORM, JWT, Helmet, express-rate-limit |
| **AI Service** | Node.js, Express, YandexGPT API (foundationModels/v1/completion) |
| **TTS Service** | Fastify, Yandex SpeechKit TTS API |
| **ASR Service** | Express, Yandex SpeechKit STT API, FFmpeg (fluent-ffmpeg) |
| **Telegram Bot** | Python 3.11, aiogram 3.x, python-socketio, aiohttp |
| **Frontend** | React 18, Vite, TailwindCSS, React Query |
| **Database** | PostgreSQL 15, Redis 7 |
| **Infra** | Docker Compose, node-cron |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              –ö–õ–ò–ï–ù–¢–´                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     Web Frontend (:80)          ‚îÇ           Telegram Bot                     ‚îÇ
‚îÇ     React + Vite                ‚îÇ           aiogram 3.x + Socket.IO          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ HTTP + WebSocket                    ‚îÇ WebSocket (python-socketio)
                ‚îÇ                                     ‚îÇ
                ‚ñº                                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         API GATEWAY (:3001)                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ  Express.js + Socket.IO Server                                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ REST API (/api/auth, /api/chat, /api/telegram, /api/payment)      ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ WebSocket Events (telegram_response, user_authed, new_message)    ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ JWT Authentication + Redis Token Blocklist                        ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ Rate Limiting (20 req/15min –¥–ª—è /api/auth)                        ‚îÇ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ CORS (localhost, morpheusantihype.icu)                            ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                  ‚îÇ                  ‚îÇ                  ‚îÇ
           ‚ñº                  ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AI Service      ‚îÇ ‚îÇ  TTS Service     ‚îÇ ‚îÇ  ASR Service     ‚îÇ ‚îÇ PostgreSQL   ‚îÇ
‚îÇ  (:3002)         ‚îÇ ‚îÇ  (:3010)         ‚îÇ ‚îÇ  (:3020)         ‚îÇ ‚îÇ (:5433)      ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ              ‚îÇ
‚îÇ  YandexGPT       ‚îÇ ‚îÇ  Yandex TTS      ‚îÇ ‚îÇ  Yandex STT      ‚îÇ ‚îÇ Prisma ORM   ‚îÇ
‚îÇ  - /interpret    ‚îÇ ‚îÇ  - /synthesize   ‚îÇ ‚îÇ  - /stt          ‚îÇ ‚îÇ              ‚îÇ
‚îÇ  - /classify-    ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ  FFmpeg          ‚îÇ ‚îÇ Redis (:6379)‚îÇ
‚îÇ    intent        ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ  –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è     ‚îÇ ‚îÇ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

**Web-–∫–ª–∏–µ–Ω—Ç ‚Üí –¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–Ω–∞:**
```
1. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST /api/chat/new —Å —Ç–µ–∫—Å—Ç–æ–º —Å–Ω–∞
2. API Gateway –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω
3. chat.service –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. ai.service –≤—ã–∑—ã–≤–∞–µ—Ç /classify-intent –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
5. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ —Å–Ω–µ ‚Üí –≤—ã–∑–æ–≤ /interpret —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–æ–≤
6. –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ PostgreSQL (ChatSession + Message)
7. WebSocket —Å–æ–±—ã—Ç–∏–µ 'new_message' –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
```

**Telegram-–±–æ—Ç ‚Üí –¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–Ω–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ –±–æ—Ç
2. user_handlers.py —á–µ—Ä–µ–∑ api_client –≤—ã–∑—ã–≤–∞–µ—Ç /api/telegram/interpret
3. telegram.service –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ telegramId
4. chat.service –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ web)
5. –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket —Å–æ–±—ã—Ç–∏–µ 'telegram_response'
6. bot.py –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Prisma)

### –°—Ö–µ–º–∞ –º–æ–¥–µ–ª–µ–π

```prisma
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã
model User {
  id                       String             @id @default(uuid())
  email                    String?            @unique
  phone                    String?            @unique
  passwordHash             String?
  name                     String?
  birthDate                DateTime?          @db.Date
  telegramId               BigInt?            @unique  // –°–≤—è–∑—å —Å Telegram

  // –ü–æ–¥–ø–∏—Å–∫–∞
  subscriptionStatus       SubscriptionStatus @default(FREE)
  subscriptionExpiresAt    DateTime?
  remainingInterpretations Int                @default(3)  // –°—á–µ—Ç—á–∏–∫ –ª–∏–º–∏—Ç–æ–≤
  lastFreeInterpretationAt DateTime?          // –î–ª—è cooldown FREE

  // –†–æ–ª–∏ –∏ —Å—Ç–∞—Ç—É—Å
  role                     UserRole           @default(USER)
  status                   UserStatus         @default(ACTIVE)  // BANNED –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø

  chatSessions             ChatSession[]
  payments                 Payment[]
}

// –°–µ—Å—Å–∏—è –¥–∏–∞–ª–æ–≥–∞ (–æ–¥–∏–Ω —Å–æ–Ω = –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è)
model ChatSession {
  id        String    @id @default(uuid())
  userId    String
  title     String    // –ü–µ—Ä–≤—ã–µ 40 —Å–∏–º–≤–æ–ª–æ–≤ —Å–Ω–∞
  createdAt DateTime  @default(now())

  user      User      @relation(...)
  messages  Message[]

  @@index([userId])  // –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
}

// –°–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ
model Message {
  id        String      @id @default(uuid())
  sessionId String
  role      MessageRole // 'user' | 'assistant'
  content   String      @db.Text
  audioUrls String[]    @default([])  // URL –∞—É–¥–∏–æ-–≤–µ—Ä—Å–∏–π (TTS)
  createdAt DateTime    @default(now())

  session   ChatSession @relation(...)

  @@index([sessionId])
}

// –ü–ª–∞—Ç–µ–∂–∏
model Payment {
  id                String        @id @default(uuid())
  userId            String
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("RUB")
  status            PaymentStatus @default(PENDING)  // PENDING ‚Üí COMPLETED/FAILED
  provider          String        @default("robokassa")
  providerPaymentId String?       @unique
}

enum SubscriptionStatus { FREE, PREMIUM }
enum MessageRole { user, assistant }
enum PaymentStatus { PENDING, COMPLETED, FAILED }
enum UserRole { USER, ADMIN }
enum UserStatus { ACTIVE, BANNED }
```

### –ü–æ—á–µ–º—É —Ç–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

1. **telegramId –∫–∞–∫ BigInt** ‚Äî Telegram ID –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å MAX_SAFE_INTEGER –≤ JavaScript
2. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ email/phone** ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º
3. **remainingInterpretations + lastFreeInterpretationAt** ‚Äî –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤
4. **–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ userId –∏ sessionId** ‚Äî –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
5. **status: BANNED** ‚Äî –ú—è–≥–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

### 1. API Gateway

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–π –≤—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

#### 1.1 WebSocket –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`socket.js`)

```javascript
io.use((socket, next) => {
  const token = socket.handshake.auth.token;

  // –í–∞—Ä–∏–∞–Ω—Ç 1: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–∏—Å (Telegram-–±–æ—Ç)
  if (token === process.env.INTERNAL_SERVICE_SECRET) {
    socket.isBot = true;
    socket.isAuthed = true;
    return next();
  }

  // –í–∞—Ä–∏–∞–Ω—Ç 2: JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (token) {
    jwt.verify(token, process.env.JWT_SECRET, (err, decoded) => {
      if (err) {
        socket.isAuthed = false;
        return next();  // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –Ω–æ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      }
      socket.userId = decoded.userId;
      socket.isAuthed = true;
      next();
    });
  } else {
    socket.isAuthed = false;
    next();  // –ì–æ—Å—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  }
});

// –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è –∞–¥—Ä–µ—Å–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
const userSocketMap = {};

io.on('connection', (socket) => {
  if (socket.isBot) {
    userSocketMap['bot'] = socket.id;  // –ë–æ—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–¥ –∫–ª—é—á–æ–º 'bot'
  } else if (socket.isAuthed && socket.userId) {
    userSocketMap[socket.userId] = socket.id;  // userId ‚Üí socketId
  }
});
```

**–ó–∞—á–µ–º:**
- –ë–æ—Ç –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á, –Ω–µ —Ç—Ä–µ–±—É—è JWT
- –ì–æ—Å—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—É–±–ª–∏—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- `userSocketMap` –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

#### 1.2 JWT Middleware —Å Redis Blocklist (`auth.middleware.js`)

```javascript
export const protect = asyncHandler(async (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ logout (—Ç–æ–∫–µ–Ω –≤ blocklist)
  const isBlocked = await redisClient.get(`blocklist:${token}`);
  if (isBlocked) {
    throw new Error('–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (logout)');
  }

  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è JWT –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
  const decoded = jwt.verify(token, process.env.JWT_SECRET);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = await prisma.user.findUnique({ where: { id: decoded.userId } });
  if (!user || user.status === 'BANNED') {
    throw new Error('–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
  }

  req.user = user;
  next();
});
```

**Logout —Å blocklist:**
```javascript
const logoutUser = async (token) => {
  const decoded = jwt.decode(token);
  const remainingSeconds = decoded.exp - Math.floor(Date.now() / 1000);

  if (remainingSeconds > 0) {
    // –•—Ä–∞–Ω–∏–º —Ç–æ–∫–µ–Ω –≤ blocklist –¥–æ –µ–≥–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
    await redisClient.setEx(`blocklist:${token}`, remainingSeconds, 'true');
  }
};
```

**–ó–∞—á–µ–º Redis blocklist:**
- JWT stateless ‚Äî –Ω–µ–ª—å–∑—è "–æ—Ç–æ–∑–≤–∞—Ç—å" —Ç–æ–∫–µ–Ω
- Blocklist –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ logout
- TTL = –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (—ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏)

#### 1.3 –°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ (`chat.service.js`)

```javascript
const INTERPRETATION_LIMITS = {
  FREE_INITIAL_COUNT: 3,      // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –ø–æ–ø—ã—Ç–∫–∏
  PREMIUM_DAILY_COUNT: 20,    // –î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç Premium
  FREE_COOLDOWN_DAYS: 3,      // –ö—É–ª–¥–∞—É–Ω –¥–ª—è FREE
};

async _checkAndDecrementInterpretations(userId) {
  const user = await prisma.user.findUnique({ where: { id: userId } });
  let hasAccess = false;

  if (user.subscriptionStatus === 'PREMIUM') {
    // Premium: –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—á–µ—Ç—á–∏–∫
    hasAccess = user.remainingInterpretations > 0;
  } else {
    // FREE: —Å—á–µ—Ç—á–∏–∫ –ò–õ–ò –ø—Ä–æ—à–µ–ª –∫—É–ª–¥–∞—É–Ω
    const cooldownDate = new Date();
    cooldownDate.setDate(cooldownDate.getDate() - INTERPRETATION_LIMITS.FREE_COOLDOWN_DAYS);

    hasAccess = user.remainingInterpretations > 0 ||  // –ï—Å—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ
                !user.lastFreeInterpretationAt ||      // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª
                user.lastFreeInterpretationAt < cooldownDate;  // –ö—É–ª–¥–∞—É–Ω –ø—Ä–æ—à–µ–ª
  }

  if (!hasAccess) {
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
    sendMessageToUser(io, userSocketMap, userId, 'error_message', {
      type: 'no_interpretations',
      content: '–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω'
    });
    throw error;
  }

  // –î–µ–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞
  const updateData = {};
  if (user.subscriptionStatus === 'PREMIUM') {
    updateData.remainingInterpretations = { decrement: 1 };
  } else {
    if (user.remainingInterpretations > 0) {
      updateData.remainingInterpretations = { decrement: 1 };
    }
    updateData.lastFreeInterpretationAt = new Date();  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  }

  await prisma.user.update({ where: { id: userId }, data: updateData });
  await redisClient.del(`user:${userId}`);  // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
}
```

**–õ–æ–≥–∏–∫–∞ FREE:**
- 3 –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è (remainingInterpretations)
- –ü–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è ‚Äî 1 —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Ä–∞–∑ –≤ 3 –¥–Ω—è (cooldown)
- `lastFreeInterpretationAt` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–õ–æ–≥–∏–∫–∞ PREMIUM:**
- 20 —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–π –≤ –¥–µ–Ω—å
- –°–±—Ä–æ—Å –≤ 00:00 –ø–æ –ú–°–ö —á–µ—Ä–µ–∑ cron

#### 1.4 Cron-–∑–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ (`scheduler.js`)

```javascript
import cron from 'node-cron';

const resetPremiumLimits = async () => {
  const result = await prisma.user.updateMany({
    where: { subscriptionStatus: 'PREMIUM' },
    data: { remainingInterpretations: INTERPRETATION_LIMITS.PREMIUM_DAILY_COUNT }
  });
  console.log(`–õ–∏–º–∏—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã –¥–ª—è ${result.count} Premium-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
};

export const startSchedulers = () => {
  // –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
  cron.schedule('0 0 * * *', resetPremiumLimits, {
    timezone: "Europe/Moscow"
  });
};
```

#### 1.5 Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö—ç—à –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```javascript
const getUserById = async (userId) => {
  const cacheKey = `user:${userId}`;

  const cached = await redisClient.get(cacheKey);
  if (cached) return JSON.parse(cached);

  const user = await prisma.user.findUnique({ where: { id: userId } });
  await redisClient.setEx(cacheKey, 300, JSON.stringify(user));  // TTL 5 –º–∏–Ω—É—Ç

  return user;
};
```

**–ö—ç—à —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π:**
```javascript
const getSessionsByUser = async (userId, page, limit) => {
  const cacheKey = `sessions:user-${userId}:page-${page}:limit-${limit}`;

  const cached = await redisClient.get(cacheKey);
  if (cached) return JSON.parse(cached);

  const [sessions, totalCount] = await prisma.$transaction([
    prisma.chatSession.findMany({ where: { userId }, skip: (page-1)*limit, take: limit }),
    prisma.chatSession.count({ where: { userId } })
  ]);

  const result = { data: sessions, pagination: { totalItems: totalCount, ... } };
  await redisClient.setEx(cacheKey, 300, JSON.stringify(result));

  return result;
};
```

**–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:**
```javascript
// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
const pattern = `sessions:user-${userId}:*`;
const keys = await redisClient.keys(pattern);
if (keys.length > 0) await redisClient.del(keys);

// –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏
await redisClient.del([
  `sessions:user-${userId}:page-1:limit-15`,
  `session:${sessionId}`
]);
```

#### 1.6 Telegram WebApp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`auth.service.js`)

–í–∞–ª–∏–¥–∞—Ü–∏—è `initData` –æ—Ç Telegram Mini App:

```javascript
const linkTelegramAccount = async (userId, telegramInitData) => {
  const params = new URLSearchParams(telegramInitData);
  const hash = params.get('hash');
  const userPayload = JSON.parse(params.get('user'));
  const authDate = params.get('auth_date');

  // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  const dataToCheck = [];
  for (const [key, value] of params.entries()) {
    if (key !== 'hash') dataToCheck.push(`${key}=${value}`);
  }
  dataToCheck.sort();
  const dataCheckString = dataToCheck.join('\n');

  // 2. –í—ã—á–∏—Å–ª—è–µ–º HMAC-SHA256
  const secretKey = crypto
    .createHmac('sha256', 'WebAppData')
    .update(process.env.TELEGRAM_BOT_TOKEN)
    .digest();

  const calculatedHash = crypto
    .createHmac('sha256', secretKey)
    .update(dataCheckString)
    .digest('hex');

  // 3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö—ç—à–∏
  if (calculatedHash !== hash) {
    throw new Error('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Telegram –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞');
  }

  // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (1 —á–∞—Å)
  if (Date.now() / 1000 - parseInt(authDate) > 3600) {
    throw new Error('–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏');
  }

  // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (telegramId —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É)
  const conflictingUser = await prisma.user.findUnique({
    where: { telegramId: BigInt(userPayload.id) }
  });
  if (conflictingUser && conflictingUser.id !== userId) {
    throw new Error('Telegram —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É');
  }

  // 6. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await prisma.user.update({
    where: { id: userId },
    data: {
      telegramId: BigInt(userPayload.id),
      name: currentUser.name || userPayload.first_name  // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–º—è –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    }
  });
};
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram):**
1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∫—Ä–æ–º–µ `hash` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `key=value`
2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ —Å–æ–µ–¥–∏–Ω—è–µ–º —á–µ—Ä–µ–∑ `\n`
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º secret key: HMAC-SHA256('WebAppData', BOT_TOKEN)
4. –í—ã—á–∏—Å–ª—è–µ–º HMAC-SHA256(secret_key, data_check_string)
5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º hash

---

### 2. AI Service

–°–µ—Ä–≤–∏—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å YandexGPT.

#### 2.1 –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π (`/classify-intent`)

```javascript
app.post('/classify-intent', async (req, res) => {
  const { text } = req.body;

  const classificationPrompt = `–¢—ã ‚Äî —Ç–æ—á–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–æ–π —Å–æ–Ω, —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–µ, –∫–æ—à–º–∞—Ä –∏–ª–∏ –≤–∏–¥–µ–Ω–∏–µ.
–ù–µ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å. –ù–µ –¥–∞–≤–∞–π –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
–¢–≤–æ–π –æ—Ç–≤–µ—Ç: "true" –µ—Å–ª–∏ —ç—Ç–æ –æ —Å–Ω–µ, "false" –µ—Å–ª–∏ —ç—Ç–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å.`;

  const response = await callYandexGPT(classificationPrompt, text, [], []);
  const isDreamRelated = response.trim().toLowerCase() === 'true';

  res.json({ is_dream_related: isDreamRelated });
});
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API Gateway (`ai.service.js`):**
```javascript
export const getInterpretation = async (user, text, history, previousDreams) => {
  // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–û–í–´–• —Å–µ—Å—Å–∏–π (history.length === 0)
  if (history.length === 0) {
    const classification = await axios.post(`${AI_SERVICE_URL}/classify-intent`, { text });

    if (!classification.data.is_dream_related) {
      return {
        success: true,
        data: "–Ø ‚Äî –ú–æ—Ä—Ñ–µ—É—Å, —Ç–æ–ª–∫–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Å–æ–Ω."
      };
    }
  }

  // –ï—Å–ª–∏ –æ —Å–Ω–µ ‚Äî –≤—ã–∑—ã–≤–∞–µ–º /interpret
  const response = await axios.post(`${AI_SERVICE_URL}/interpret`, { ... });
  return { success: true, data: response.data.interpretation };
};
```

**–ó–∞—á–µ–º:**
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ ("–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?", "2+2=?")
- –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤ YandexGPT
- –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—é –¥–∏–∞–ª–æ–≥–∞ (history > 0)

#### 2.2 –¢–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Å–Ω–æ–≤ (`/interpret`)

**–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (`buildSystemPrompt`):**
```javascript
function buildSystemPrompt(request) {
  const { user_info, previous_dreams } = request;

  let systemPrompt = `–¢—ã ‚Äî ¬´–ú–æ—Ä—Ñ–µ—É—Å¬ª, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π.

// ***–û–°–ù–û–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´***
1. **–¢–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Å–Ω–æ–≤.** –û—Ç–∫–∞–∑—ã–≤–∞–π—Å—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.
2. **–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥.** –ü—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑, –≥–µ—à—Ç–∞–ª—å—Ç, –ö–ü–¢. –ë–µ–∑ –º–∏—Å—Ç–∏–∫–∏ –∏ –≥–∞–¥–∞–Ω–∏–π.
3. **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.** –°–∏–º–≤–æ–ª—ã –ª–∏—á–Ω—ã–µ. –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã, –Ω–µ –∏—Å—Ç–∏–Ω—ã.
4. **–≠–º–ø–∞—Ç–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞.** –ë–µ–∑ –∫—Ä–∏—Ç–∏–∫–∏ –∏ –æ—Å—É–∂–¥–µ–Ω–∏—è.
5. **–ö—Ä–∞—Ç–∫–æ—Å—Ç—å –∏ —è—Å–Ω–æ—Å—Ç—å.**

// ***–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï***
- –ò–º—è: ${user_info.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
${user_info.birthDate ? `- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${user_info.birthDate}` : ''}`;

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
  if (previous_dreams?.length > 0) {
    systemPrompt += `

// ***–ê–ù–ê–õ–ò–ó –í –î–ò–ù–ê–ú–ò–ö–ï (–í–ê–ñ–ù–û)***
–ï—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–Ω–∞–º. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
1. –ù–∞–π–¥–∏ —Å–≤—è–∑–∏: –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã, —Ç–µ–º—ã, —ç–º–æ—Ü–∏–∏
2. –û—Ç–º–µ—Ç—å –¥–∏–Ω–∞–º–∏–∫—É: –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∏–º–≤–æ–ª–∞—Ö –º–µ–∂–¥—É —Å–Ω–∞–º–∏
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π –≤ –æ—Ç–≤–µ—Ç –æ—Ä–≥–∞–Ω–∏—á–Ω–æ`;
  }

  systemPrompt += `

// ***–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê***
1. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
2. –ê–Ω–∞–ª–∏–∑ 2-3 –∫–ª—é—á–µ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
3. –û–±—â–∏–π –≤—ã–≤–æ–¥ –∏ —Å–≤—è–∑—å —Å –∂–∏–∑–Ω—å—é
4. 2-3 –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)`;

  return { systemPrompt };
}
```

**–í—ã–∑–æ–≤ YandexGPT (`yandexGPT.js`):**
```javascript
export async function callYandexGPT(systemPrompt, newMessageText, history, previousDreams) {
  const messages = [{ role: 'system', text: systemPrompt }];

  // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
  history.forEach(msg => {
    messages.push({
      role: msg.role === 'assistant' ? 'assistant' : 'user',
      text: msg.content
    });
  });

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–æ–≤
  let finalUserMessage = newMessageText;
  if (previousDreams.length > 0) {
    finalUserMessage = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π –Ω–æ–≤—ã–π —Å–æ–Ω, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ:\n`;
    previousDreams.forEach(dream => {
      finalUserMessage += `- "${dream.substring(0, 100)}..."\n`;
    });
    finalUserMessage += `\n---\n\n–ú–æ–π –Ω–æ–≤—ã–π —Å–æ–Ω: "${newMessageText}"\n\n–ü—Ä–æ–≤–µ–¥–∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏.`;
  }

  messages.push({ role: 'user', text: finalUserMessage });

  const response = await axios.post(
    'https://llm.api.cloud.yandex.net/foundationModels/v1/completion',
    {
      modelUri: MODEL_URI,  // gpt://folder-id/yandexgpt-lite
      completionOptions: {
        stream: false,
        temperature: 0.6,  // –ë–∞–ª–∞–Ω—Å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç–æ—á–Ω–æ—Å—Ç–∏
        maxTokens: 1500
      },
      messages
    },
    { headers: { 'Authorization': `Api-Key ${API_KEY}` } }
  );

  return response.data.result.alternatives[0].message.text;
}
```

**–ó–∞—á–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–Ω—ã:**
- –ê–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏ (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã)
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
- –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

---

### 3. TTS Service

–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ Yandex SpeechKit.

```javascript
const config = {
  yandex: {
    apiUrl: 'https://tts.api.cloud.yandex.net/speech/v1/tts:synthesize',
  },
  limits: { maxTextLength: 249 },  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ API
  defaults: {
    voice: 'ermil',      // –ú—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å
    emotion: 'neutral',
    speed: 1.0,
    format: 'mp3',
    lang: 'ru-RU',
    sampleRate: 48000,
  }
};

app.post('/synthesize', { schema: synthesizeSchema }, async (req, reply) => {
  const { text, voice, emotion, speed, format } = req.body;

  const params = new URLSearchParams({
    text,
    lang: config.defaults.lang,
    voice: voice || config.defaults.voice,
    emotion: emotion || config.defaults.emotion,
    speed: speed || config.defaults.speed,
    format: format || config.defaults.format,
    sampleRateHertz: config.defaults.sampleRate,
  });

  const response = await yandexApiClient.post('', params.toString());

  reply.header('Content-Type', format === 'ogg_opus' ? 'audio/ogg' : 'audio/mpeg');
  return reply.send(response.data);  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã–µ
});
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –õ–∏–º–∏—Ç 249 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Yandex)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ mp3 –∏ ogg_opus —Ñ–æ—Ä–º–∞—Ç–æ–≤
- Fastify –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

### 4. ASR Service

–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ Yandex SpeechKit.

```javascript
app.post('/stt', async (req, res) => {
  const inputId = uuidv4();
  const contentType = req.headers['content-type'];
  const inputPath = path.join(TEMP_DIR, `${inputId}.${extension}`);
  const outputPath = path.join(TEMP_DIR, `${inputId}-converted.ogg`);

  // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥—è—â–∏–π —Ñ–∞–π–ª
  await fs.writeFile(inputPath, req.body);

  // 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ OGG Opus —á–µ—Ä–µ–∑ FFmpeg
  await new Promise((resolve, reject) => {
    ffmpeg(inputPath)
      .toFormat('ogg')
      .audioCodec('libopus')
      .on('end', resolve)
      .on('error', reject)
      .save(outputPath);
  });

  // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Yandex STT
  const audioBuffer = await fs.readFile(outputPath);
  const response = await fetch(
    'https://stt.api.cloud.yandex.net/speech/v1/stt:recognize?lang=ru-RU&format=oggopus&sampleRateHertz=48000',
    {
      method: 'POST',
      headers: {
        'Authorization': `Api-Key ${YANDEX_API_KEY}`,
        'Content-Type': 'audio/ogg',
      },
      body: audioBuffer,
    }
  );

  const { result } = await response.json();

  // 4. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –±–∞–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
  const fixedText = fixDuplicateText(result);

  res.json({ text: fixedText });

  // 5. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
  await fs.unlink(inputPath);
  await fs.unlink(outputPath);
});

// –ë–∞–≥ Yandex STT: –∏–Ω–æ–≥–¥–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç ("–ø—Ä–∏–≤–µ—Ç –ø—Ä–∏–≤–µ—Ç")
const fixDuplicateText = (text) => {
  const mid = Math.floor(text.length / 2);
  if (text.substring(0, mid) === text.substring(mid)) {
    return text.substring(0, mid);
  }
  return text;
};
```

**–ó–∞—á–µ–º FFmpeg:**
- Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ OGG Opus
- –ë—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å WebM, WAV –∏ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã
- FFmpeg –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å—ë –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Yandex

---

### 5. Telegram Bot

–ë–æ—Ç –Ω–∞ aiogram 3.x —Å FSM (Finite State Machine).

#### 5.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–æ—Ç–∞ (`bot.py`)

```python
import socketio
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage

sio = socketio.AsyncClient()
bot_instance = Bot(token=BOT_TOKEN)

# WebSocket —Å–æ–±—ã—Ç–∏—è –æ—Ç API Gateway
@sio.event
async def telegram_response(data):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ AI –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    telegram_id = int(data['telegramId'])
    content = format_for_telegram(data['content'])
    await bot_instance.send_message(chat_id=telegram_id, text=content, parse_mode=ParseMode.HTML)

@sio.event
async def user_upgraded_to_premium(data):
    """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ Premium"""
    telegram_id = int(data['telegramId'])
    await bot_instance.send_message(
        chat_id=telegram_id,
        text="üéâ –¢–≤–æ–π —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ Premium!"
    )

@sio.event
async def user_authed(data):
    """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞"""
    telegram_id = int(data['telegramId'])
    await bot_instance.send_message(
        chat_id=telegram_id,
        text=f"–û—Ç–ª–∏—á–Ω–æ, {data.get('name')}! –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≤—è–∑–∞–Ω.",
        reply_markup=get_main_menu()
    )

async def main():
    storage = MemoryStorage()
    dp = Dispatcher(storage=storage)
    dp.include_router(user_handlers.router)

    # –ó–∞–ø—É—Å–∫ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ: WebSocket + Polling
    socket_task = asyncio.create_task(run_socketio())
    polling_task = asyncio.create_task(dp.start_polling(bot_instance))

    await asyncio.gather(socket_task, polling_task)

async def run_socketio():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API Gateway —Å —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º"""
    while True:
        try:
            await sio.connect(
                API_URL,
                auth={'token': INTERNAL_SERVICE_SECRET},
                transports=['websocket']
            )
            await sio.wait()
        except socketio.exceptions.ConnectionError:
            await asyncio.sleep(5)  # –†–µ–∫–æ–Ω–Ω–µ–∫—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
```

#### 5.2 FSM –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ (`user_handlers.py`)

```python
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters import StateFilter

class ChatStates(StatesGroup):
    in_dialogue = State()  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞

# –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
@router.message(F.text == "‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥", StateFilter(None))
async def start_dialog_handler(message: Message, state: FSMContext):
    user_data = await api_client.find_user_by_telegram_id(message.from_user.id)

    if user_data:
        await state.set_state(ChatStates.in_dialogue)
        await message.answer("–Ø –≥–æ—Ç–æ–≤ —Å–ª—É—à–∞—Ç—å. –û–ø–∏—à–∏ —Å–≤–æ–π —Å–æ–Ω.", reply_markup=get_dialog_menu())
    else:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.", reply_markup=get_onboarding_keyboard())

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ
@router.message(StateFilter(ChatStates.in_dialogue))
async def dialogue_message_handler(message: Message, state: FSMContext, bot: Bot):
    telegram_id = message.from_user.id
    data = await state.get_data()
    session_id = data.get("session_id")

    await bot.send_chat_action(chat_id=message.chat.id, action=ChatAction.TYPING)

    if not session_id:
        # –ù–æ–≤—ã–π —Å–æ–Ω ‚Üí —Å–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é
        response = await api_client.send_dream(telegram_id, message.text)

        if response and response.get("sessionId"):
            await state.update_data(session_id=response["sessionId"])
            formatted = format_message_to_html(response.get("initialResponse"))
            sent = await bot.send_message(message.chat.id, formatted, parse_mode=ParseMode.HTML)
            await sent.edit_reply_markup(reply_markup=get_tts_keyboard(sent.message_id))
        else:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ª–∏–º–∏—Ç–æ–≤
            if "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å" in response.get("error", ""):
                await handle_interpretations_exhausted(message, state, user_data)
    else:
        # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
        response = await api_client.send_follow_up(session_id, telegram_id, message.text)
        formatted = format_message_to_html(response.get("response"))
        sent = await bot.send_message(message.chat.id, formatted, parse_mode=ParseMode.HTML)
        await sent.edit_reply_markup(reply_markup=get_tts_keyboard(sent.message_id))

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
@router.message(F.text == "‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–ª–æ–≥", StateFilter(ChatStates.in_dialogue))
async def end_dialog_handler(message: Message, state: FSMContext):
    await state.clear()
    await message.answer("–î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω.", reply_markup=get_main_menu())
```

**–ó–∞—á–µ–º FSM:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –¥–∏–∞–ª–æ–≥–µ / –Ω–µ –≤ –¥–∏–∞–ª–æ–≥–µ)
- –•—Ä–∞–Ω–µ–Ω–∏–µ `session_id` –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

#### 5.3 –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (Premium)

```python
@router.message(F.voice, StateFilter(ChatStates.in_dialogue))
async def voice_message_handler(message: Message, state: FSMContext, bot: Bot):
    telegram_id = message.from_user.id
    user_data = await api_client.find_user_by_telegram_id(telegram_id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium
    if user_data.get("subscriptionStatus") != "PREMIUM":
        await message.answer(
            "üéôÔ∏è –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Premium.",
            reply_markup=get_premium_feature_keyboard()
        )
        return

    # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    file_info = await bot.get_file(message.voice.file_id)
    file_path = f"temp_{telegram_id}.ogg"
    await bot.download_file(file_info.file_path, destination=file_path)

    await bot.send_chat_action(chat_id=message.chat.id, action=ChatAction.TYPING)

    # –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ASR Service
    response = await api_client.recognize_voice(telegram_id, file_path)
    os.remove(file_path)

    if response and response.get("text"):
        # –°–æ–∑–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–¥–∞—ë–º –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        message_data = message.model_dump()
        message_data['text'] = response.get("text")
        new_message = Message(**message_data)
        await dialogue_message_handler(message=new_message, state=state, bot=bot)
    else:
        await message.answer("–ù–µ —Å–º–æ–≥ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.")
```

#### 5.4 TTS (–æ–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤)

```python
TTS_CACHE_TTL = 3 * 24 * 60 * 60  # 3 –¥–Ω—è

@router.callback_query(F.data.startswith("tts_"))
async def tts_callback_handler(callback: CallbackQuery, bot: Bot):
    message_id = int(callback.data.split("_")[1])
    redis_key = f"tts_cache:{callback.message.chat.id}:{message_id}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–Ω–µ –æ–∑–≤—É—á–∏–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
    if await redis_client.get(redis_key):
        await callback.answer("–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ –æ–∑–≤—É—á–µ–Ω–æ.", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ Premium
    user_data = await api_client.find_user_by_telegram_id(callback.from_user.id)
    if user_data.get("subscriptionStatus") != "PREMIUM":
        await callback.answer("üîä –û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è Premium.", show_alert=True)
        return

    text = callback.message.text
    await bot.send_chat_action(chat_id=callback.message.chat.id, action=ChatAction.RECORD_VOICE)

    # –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ TTS Service
    audio_data = await api_client.synthesize_speech(callback.from_user.id, text)

    if audio_data and isinstance(audio_data, bytes):
        voice_file = BufferedInputFile(audio_data, filename="voice.ogg")
        await callback.message.answer_voice(voice=voice_file)

        # –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 3 –¥–Ω—è
        await redis_client.setex(redis_key, TTS_CACHE_TTL, "1")

        # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É TTS
        await callback.message.edit_reply_markup(reply_markup=None)
```

---

## –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

### –ü–æ–ª–Ω—ã–π flow —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Å–Ω–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç —Å–Ω–∞                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. API Gateway: protect middleware                                        ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞                                                 ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∫–∞ blocklist –≤ Redis                                          ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ BANNED)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. chat.service._checkAndDecrementInterpretations                        ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (FREE/PREMIUM)                                     ‚îÇ
‚îÇ    - –î–µ–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞                                                  ‚îÇ
‚îÇ    - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ user:{id}                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. ai.service.getInterpretation                                          ‚îÇ
‚îÇ    - POST /classify-intent ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ "—ç—Ç–æ –æ —Å–Ω–µ?"                       ‚îÇ
‚îÇ    - –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –≤–µ–∂–ª–∏–≤–æ–≥–æ –æ—Ç–∫–∞–∑–∞                                 ‚îÇ
‚îÇ    - –ï—Å–ª–∏ –¥–∞ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–æ–≤                                              ‚îÇ
‚îÇ    - prisma.chatSession.findMany (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–µ—Å—Å–∏–∏)                    ‚îÇ
‚îÇ    - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ user-—Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–∂–¥–æ–π                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. POST /interpret ‚Üí AI Service                                          ‚îÇ
‚îÇ    - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º                        ‚îÇ
‚îÇ    - –í—ã–∑–æ–≤ YandexGPT API                                                 ‚îÇ
‚îÇ    - temperature: 0.6, maxTokens: 1500                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î                                                       ‚îÇ
‚îÇ    - CREATE ChatSession (title = –ø–µ—Ä–≤—ã–µ 40 —Å–∏–º–≤–æ–ª–æ–≤)                     ‚îÇ
‚îÇ    - CREATE Message (role: user)                                         ‚îÇ
‚îÇ    - CREATE Message (role: assistant)                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ                                        ‚îÇ
‚îÇ    - redis.del(sessions:user-{id}:*)                                     ‚îÇ
‚îÇ    - WebSocket: emit('new_message', {...})                               ‚îÇ
‚îÇ    - WebSocket: emit('new_activity', {title}) ‚Üí –≤—Å–µ–º                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ Premium —á–µ—Ä–µ–∑ WebSocket

```javascript
// payment.service.js
const upgradeToPremium = async (userId) => {
  const user = await prisma.user.update({
    where: { id: userId },
    data: {
      subscriptionStatus: 'PREMIUM',
      remainingInterpretations: INTERPRETATION_LIMITS.PREMIUM_DAILY_COUNT,
    }
  });

  await redisClient.del(`user:${userId}`);

  // –ï—Å–ª–∏ –ø—Ä–∏–≤—è–∑–∞–Ω Telegram ‚Äî —É–≤–µ–¥–æ–º–ª—è–µ–º –±–æ—Ç–∞
  if (user.telegramId) {
    sendMessageToUser(io, userSocketMap, 'bot', 'user_upgraded_to_premium', {
      telegramId: user.telegramId.toString(),
      name: user.name,
    });
  }
};

// bot.py
@sio.event
async def user_upgraded_to_premium(data):
    await bot_instance.send_message(
        chat_id=int(data['telegramId']),
        text="üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, —Ç–≤–æ–π —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ Premium!"
    )
```

---

## API Endpoints

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`/api/auth`)

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ | Rate Limit |
|--------|----------|----------|------------|
| POST | `/register` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (email/phone + password) | 20/15min |
| POST | `/login` | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí JWT —Ç–æ–∫–µ–Ω | 20/15min |
| POST | `/logout` | –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ | - |
| GET | `/me` | –ü—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | - |
| PUT | `/me` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (name, birthDate) | - |
| PUT | `/me/password` | –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è | - |
| POST | `/link-telegram` | –ü—Ä–∏–≤—è–∑–∫–∞ Telegram (initData) | - |

### –ß–∞—Ç (`/api/chat`)

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| POST | `/new` | –ù–æ–≤–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ (source: web) |
| POST | `/:sessionId/message` | –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ |
| GET | `/sessions` | –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π (page, limit) |
| GET | `/sessions/:id` | –î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ |
| DELETE | `/sessions/:id` | –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ |

### Telegram API (`/api/telegram`)

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/user/:telegramId` | –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID |
| POST | `/interpret` | –ù–æ–≤–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ (telegramId, text) |
| POST | `/interpret/:sessionId` | –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ |
| GET | `/history/:telegramId` | –ò—Å—Ç–æ—Ä–∏—è —Å–µ—Å—Å–∏–π |
| GET | `/session/:id` | –î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏ |
| DELETE | `/session/:id` | –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ |
| POST | `/tts` | –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (proxy) |
| POST | `/stt` | –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (proxy) |

### –ü–ª–∞—Ç–µ–∂–∏ (`/api/payment`)

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| POST | `/upgrade` | –ê–ø–≥—Ä–µ–π–¥ –¥–æ Premium |

---

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker & Docker Compose
- Node.js 18+ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- Python 3.11+ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–æ—Ç–∞)

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
git clone https://github.com/3r0ha/morpheus-project.git
cd morpheus-project

# 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å .env —Ñ–∞–π–ª—ã)
cp api-gateway/.env.example api-gateway/.env
cp ai-service/app/.env.example ai-service/app/.env
cp tts-service/.env.example tts-service/.env
cp asr-service/.env.example asr-service/.env
cp telegram-bot/.env.example telegram-bot/.env

# 3. –ó–∞–ø—É—Å–∫
docker-compose up -d

# 4. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
docker exec morpheus_api_gateway npx prisma migrate deploy

# 5. –õ–æ–≥–∏
docker-compose logs -f api-gateway
docker-compose logs -f telegram-bot
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**api-gateway/.env:**
```env
DATABASE_URL=postgresql://antihype:NischiyHype123@postgres-db:5432/sonnik_db
REDIS_URL=redis://redis-cache:6379
JWT_SECRET=your-super-secret-jwt-key
AI_SERVICE_URL=http://ai-service:3002
TTS_SERVICE_URL=http://tts-service:3010
ASR_SERVICE_URL=http://asr-service:3020
TELEGRAM_BOT_TOKEN=your-telegram-bot-token
INTERNAL_SERVICE_SECRET=your-internal-secret
```

**ai-service/app/.env:**
```env
YANDEX_API_KEY=your-yandex-api-key
YANDEX_MODEL_URI=gpt://your-folder-id/yandexgpt-lite
```

**tts-service/.env:**
```env
YANDEX_API_KEY=your-yandex-api-key
YANDEX_FOLDER_ID=your-folder-id
```

**asr-service/.env:**
```env
YANDEX_API_KEY=your-yandex-api-key
```

**telegram-bot/.env:**
```env
BOT_TOKEN=your-telegram-bot-token
API_BASE_URL=http://api-gateway:3001/api
INTERNAL_SERVICE_SECRET=your-internal-secret
REDIS_HOST=redis-cache
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
morpheus-project/
‚îú‚îÄ‚îÄ api-gateway/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                      # REST endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, –ø—Ä–æ—Ñ–∏–ª—å
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat/                 # –°–µ—Å—Å–∏–∏, —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram/             # API –¥–ª—è –±–æ—Ç–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payment/              # –ê–ø–≥—Ä–µ–π–¥ Premium
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin/                # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ socket.js             # WebSocket –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ socketHelpers.js      # sendMessageToUser, broadcastActivity
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.js              # Redis –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma.js             # Prisma –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants.js          # INTERPRETATION_LIMITS, JWT_EXPIRATION
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ statusStore.js        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞ (UP/DOWN)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.js       # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ª–æ–≥–∏–Ω, Telegram link
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.service.js       # –õ–∏–º–∏—Ç—ã, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai.service.js         # –í—ã–∑–æ–≤ AI Service
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ telegram.service.js   # –ü–æ–∏—Å–∫ –ø–æ telegramId
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment.service.js    # upgradeToPremium + WS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.js    # protect (JWT + blocklist)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error.middleware.js   # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sanitization.middleware.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cron/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scheduler.js          # –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ Premium –≤ 00:00 –ú–°–ö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.js                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ prisma/
‚îÇ       ‚îî‚îÄ‚îÄ schema.prisma             # –ú–æ–¥–µ–ª–∏ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ ai-service/
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ index.js                  # /interpret, /classify-intent
‚îÇ       ‚îî‚îÄ‚îÄ yandexGPT.js              # –í—ã–∑–æ–≤ YandexGPT API
‚îÇ
‚îú‚îÄ‚îÄ tts-service/
‚îÇ   ‚îî‚îÄ‚îÄ server.js                     # /synthesize ‚Üí Yandex TTS
‚îÇ
‚îú‚îÄ‚îÄ asr-service/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îî‚îÄ‚îÄ index.js                  # /stt ‚Üí FFmpeg ‚Üí Yandex STT
‚îÇ
‚îú‚îÄ‚îÄ telegram-bot/
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                        # Main: Dispatcher + Socket.IO client
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ handlers/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user_handlers.py      # FSM, –∫–æ–º–∞–Ω–¥—ã, callbacks
‚îÇ       ‚îú‚îÄ‚îÄ keyboards/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ inline_keyboards.py   # –ö–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ reply_keyboards.py    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ api_client.py         # HTTP –∫–ª–∏–µ–Ω—Ç –∫ API Gateway
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ redis_client.py       # Redis –¥–ª—è TTS –∫—ç—à–∞
‚îÇ       ‚îî‚îÄ‚îÄ states/
‚îÇ           ‚îî‚îÄ‚îÄ chat_states.py        # ChatStates.in_dialogue
‚îÇ
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ components/               # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ pages/                    # –°—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ       ‚îú‚îÄ‚îÄ services/                 # API –∫–ª–∏–µ–Ω—Ç
‚îÇ       ‚îî‚îÄ‚îÄ context/                  # Auth context
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ README.md
```

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
